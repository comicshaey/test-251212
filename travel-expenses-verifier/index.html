<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>관내여비 지급내역 검증기</title>

  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>

  <style>
    .page-wrap {
      max-width: 880px;
      margin: 0 auto;
      padding: 24px 16px 32px;
    }
    .file-area {
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 16px 18px;
      background: #fff;
      margin: 18px 0;
    }
    .file-area p { margin: 8px 0; }
    .log-box {
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      padding: 10px 12px;
      background: #fafafa;
      font-size: 0.95rem;
      white-space: pre-wrap;
      margin-top: 8px;
      max-height: 260px;
      overflow: auto;
    }
    .result-box {
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      padding: 10px 12px;
      background: #fafafa;
      margin: 12px 0;
    }
    .result-box h3 { margin-top: 0; }
    .result-box textarea {
      width: 100%;
      min-height: 160px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
      border-radius: 8px;
      border: 1px solid #d4d4d8;
      padding: 8px 10px;
      background: #f9fafb;
      resize: vertical;
      white-space: pre;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      font-size: 0.8rem;
      border-radius: 999px;
      background: #eef2ff;
      color: #1f2937;
      border: 1px solid #c7d2fe;
    }
  </style>
</head>
<body>


  <header class="site-header">
    <div class="shell">
      <h1>관내여비 지급내역 검증기</h1>
      <p class="sub">
        ·서버 없어서 pyodide 사용함. 서버 갖고 싶다. <br/>
        ·지출결의 시 첨부하는 나이스 엑셀 파일 업로드하면 반일/종일 맞게 지급됐는지 검토함 <br/>
        ·아직 관내-반일/종일 여부에 따라 금액이 1만원/2만원 중에 맞게 지급됐는지 일치 여부만 확인하는 기능이니 너무 기대하지는 마시오. <br/> 
        <br/>
      </p>
    </div>
  </header>

  <main class="page-wrap">
    <section class="section">
      <h2 class="local-h2">*사용 방법 설명</h2>
      <p>
        ·CSV 파일만 업로드 가능함. xlsx (엑셀통합문서) 업로드 불가. <br/>
        ·첫 행 순서는 아래와 같아야 함. 병합셀 있으면 오류 뜨니까 병합된 열은 삭제 처리하쇼. <br>
      </p>
      <pre class="log-box">시작일/ 종료일/ 출장구분/ 출장자/ 계좌정보/ 출장지/ 출장목적/ 부지급/ 여비금액/ 사업정보/ 지급금액</pre>

     <p class="sub">
        ·출장구분 열에 "관내"라는 단어가 들어간 행만 추출함. (예: 관내-반일, 관내-종일 등) <br/>
        ·부지급 열이 "아니오"인 행만 추출함. <br/>
        ·금액 검증은 기본적으로 지급금액 열에 기재된 금액을 기준으로 함. 지급금액이 비었거나 0이면 여비금액 열에 기재된 금액으로 자동 대체함. <br/> 
        <br/>
      </p>

      
    </section>

    <section class="section file-area">
      <h2 class="local-h2">*파일 업로드 및 검증 실행 (CSV 파일) </h2>

      <p>
        ·"Pyodide + pandas 로딩 완료"라는 문구 뜰 때까지 기다리쇼. 자바스크립트에서 파이썬 기능 불러오느라 좀 걸림. <br/>
        ·최대 3년치(36개월)까지 업로드해도 됨. <br/>
      </p>

      <div class="row" style="margin-top:10px;">
        <input type="file" id="fileInput" accept=".csv" multiple />
        <button type="button" class="btn primary" id="runAuditBtn">검증 실행</button>
      </div>

      <div id="pyLog" class="log-box">
        Pyodide 로딩 대기 중임….
      </div>
    </section>

    <section class="section">
      <h2 class="local-h2">*결과 및 설명</h2>

        <p class="local-small muted">
          ·3번만 보면 됨.
        </p>

      
      <div class="result-box">
        <h3 class="local-h3">1. 지급 건수 집계</h3>
        <p class="local-small muted">
          ·지급 건수 표시함.
        </p>
        <textarea id="summaryOutput" readonly></textarea>
      </div>

      <div class="result-box">
        <h3 class="local-h3">2. 오지급 가능성 있는 항목</h3>
        <p class="local-small muted">
          ·단가 이상이나, 중복지급 여부, 시간, 출장 종류 등 오지급 가능성 있는지 여부 표시됨.
        </p>
        <textarea id="detailOutput" readonly></textarea>
      </div>

      <div class="result-box">
        <h3 class="local-h3">3. 결과 설명</h3>
        <textarea id="explainOutput" readonly style="white-space: pre-wrap; word-wrap: break-word;"></textarea>

      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="shell">
      <p>관내여비 지급내역 검증기</p>
      <p class="muted">
        ·실제 지급 또는 감사 및 점검 시에는 여비 규정이랑 기관 지침, 명령서·출장보고서 등 확인 필요. 아직 대충 페이지만 개설해둔 거니까 너무 믿지 마쇼
      </p>
    </div>
  </footer>

  <script>
    let pyodideReadyPromise = null;

    async function initPyodideAndPackages() {
      const logEl = document.getElementById("pyLog");
      logEl.textContent = "Pyodide 로딩 중…";

      const pyodide = await loadPyodide();
      logEl.textContent = "pandas 패키지 로딩 중…";
      await pyodide.loadPackage("pandas");

      const pythonCode = `
import pandas as pd

DATE_COL        = "시작일"
END_DATE_COL    = "종료일"
TYPE_COL        = "출장구분"
NAME_COL        = "출장자"
ACCOUNT_COL     = "계좌정보"
PLACE_COL       = "출장지"
PURPOSE_COL     = "출장목적"
FLAG_COL        = "부지급"
INNER_KEYWORD   = "관내"
FARE_COL        = "여비금액"
BIZINFO_COL     = "사업정보"
AMOUNT_COL      = "지급금액"

# 관내 단가
ALLOWED_AMOUNTS = {10000, 20000}

# 학교 소재지 키워드(관내 판단에 참고) - 필요 시 학교 바뀌면 여기를 수정
HOME_REGION_KEYWORDS = ["서울", "서울특별시"]
# 관외 후보 지역 키워드(예: 시·도 이름)
OUTER_REGION_HINTS = ["서울", "부산", "대구", "인천", "광주", "대전", "울산", "세종"]

def normalize_date_series(s):
    return pd.to_datetime(s, errors="coerce")

def make_explanation(summary_df):
    lines = []
    if summary_df.empty:
        lines.append("관내여비로 집계된 행이 없음. 설명 만들 수 없음.")
    else:
        for row in summary_df.itertuples(index=False):
            ym = row.연월
            total = int(row.관내여비_총액)
            cnt = int(row.지급건수)
            abnormal = int(row.이상행_건수)
            min_amt = int(row.최소금액)
            max_amt = int(row.최대금액)
            all_ok = bool(row.전건_허용단위금액)

            dup = int(getattr(row, "중복의심_건수", 0))
            time_sus = int(getattr(row, "시간요건의심_건수", 0))
            region_sus = int(getattr(row, "관외관내불일치의심_건수", 0))
            budget_sus = int(getattr(row, "예산코드의심_건수", 0))

            base_line = ""
            if all_ok:
                base_line = (
                    f"{ym}: 관내여비 {cnt}건, 합계 {total:,}원."
                    f" 전부 관내 단가(10,000원/ 20,000원) 범위 안에서 지급된 걸로 보임."
                    " 단가만 놓고 보면 반일/종일 여비 기준에 맞게 지급된 걸로 봐도 될 듯함."
                )
            else:
                base_line = (
                    f"{ym}: 관내여비 {cnt}건, 합계 {total:,}원 중 단가 이상행 {abnormal}건 있음."
                    f" 최소금액 {min_amt:,}원, 최대금액 {max_amt:,}원이라,"
                    " 관내 여비 단가(10,000원/ 20,000원)를 벗어나는 건이 일부 있음."
                    " 그렇게 지급한 이유가 있는지, 오지급 가능성은 없는지 한 번쯤 확인해보는 게 좋음."
                )

            extra_parts = []
            if dup > 0:
                extra_parts.append(f"같은 날 같은 사람 중복 지급 의심 {dup}건 있음")
            if time_sus > 0:
                extra_parts.append(f"반일/종일 시간 요건 다시 볼만한 건 {time_sus}건")
            if region_sus > 0:
                extra_parts.append(f"관외로 보이는 출장지에 관내단가 들어간 건 의심 {region_sus}건")
            if budget_sus > 0:
                extra_parts.append(f"사업정보에 '관내여비' 문구 없는 건 {budget_sus}건")

            if extra_parts:
                base_line += " 추가로, " + ", ".join(extra_parts) + " 있어서 건별로 사유 한 번씩 보는 게 좋음."

            lines.append(base_line)

    lines.append("")
    lines.append("[관내출장 여비 관련 취지·참고 메모]")
    lines.append("- 관내출장 여비는 보통 반일/종일 단위 정액 여비로 운영되고, 기관 여비지침에서 단가(예: 10,000원/20,000원) 정해둠.")
    lines.append("- 같은 유형의 관내출장이면 보통 같은 단가 쓰는 게 원칙임.")
    lines.append("- 같은 날 같은 사람한테 여러 건 나갔으면, 실제로는 한 번 나가서 중복 청구된 건 아닌지 보는 게 좋음.")
    lines.append("- 반일/종일 구분에 비해 시간이 너무 짧거나 길면, 근무·출장 시간 입력이랑 명령 내용이랑 맞는지 한번 체크해보는 게 좋음.")
    lines.append("- 관내로 입력돼 있는데 출장지가 다른 시·도로 보이면, 실제로 관내 기준(거리·행정구역 등)에 맞는지 애매할 수 있음.")
    lines.append("- 사업정보(예산 코드)에 '관내여비' 비슷한 문구가 없으면, 그 예산에서 관내여비 쓰는 구조가 맞는지도 같이 보는 게 좋음.")
    lines.append("- 이 도구가 찍어주는 플래그들은 '위반 확정'이 아니라, 사람 눈으로 다시 보면 좋겠다 싶은 구간 표시 정도라고 보면 됨.")
    return "\\n".join(lines)

def audit_inner_travel_csv(file_list):
    frames = []
    for path in file_list:
        try:
            df = pd.read_csv(path)
            if df is None or df.empty:
                continue
            tmp = df.copy()
            tmp["__파일명"] = path
            tmp["__시트명"] = "CSV"
            frames.append(tmp)
        except Exception as e:
            print(f"[경고] CSV 읽기 실패: {path} -> {e}")

    if not frames:
        raise ValueError("CSV에서 읽어온 데이터가 없습니다. 파일 구조(구분자, 인코딩 등)를 확인하세요.")

    df_all = pd.concat(frames, ignore_index=True)

    required_cols = [
        DATE_COL, END_DATE_COL, TYPE_COL, NAME_COL, FLAG_COL,
        FARE_COL, AMOUNT_COL
    ]
    missing = [c for c in required_cols if c not in df_all.columns]
    if missing:
        raise ValueError(f"다음 열을 찾을 수 없습니다. CSV 헤더를 확인하세요: {missing}")

    # 관내 필터
    mask_inner = df_all[TYPE_COL].astype(str).str.contains(INNER_KEYWORD, na=False)
    df = df_all[mask_inner].copy()
    if df.empty:
        raise ValueError("출장구분에 '관내'가 포함된 행이 없습니다.")

    # 부지급 = 아니오
    df = df[df[FLAG_COL].astype(str).str.strip() == "아니오"].copy()
    if df.empty:
        raise ValueError("관내 행 중 부지급='아니오' 인 행이 없습니다.")

    # 날짜·시간
    df["__시작"] = normalize_date_series(df[DATE_COL])
    df["__종료"] = normalize_date_series(df[END_DATE_COL])
    df["연월"] = df["__시작"].dt.to_period("M").astype(str)
    df["근무일"] = df["__시작"].dt.date

    # 소요시간(시간 단위)
    delta = (df["__종료"] - df["__시작"])
    df["소요시간_시간"] = delta.dt.total_seconds() / 3600.0

    # 금액
    raw_amount = pd.to_numeric(df[AMOUNT_COL], errors="coerce")
    raw_fare   = pd.to_numeric(df[FARE_COL], errors="coerce")
    df["__여비금액"] = raw_fare.fillna(0).astype(int)
    df["__지급액"] = raw_amount.copy()
    need_fare = df["__지급액"].isna() | (df["__지급액"] == 0)
    df.loc[need_fare, "__지급액"] = df.loc[need_fare, "__여비금액"]
    df["__지급액"] = df["__지급액"].fillna(0).astype(int)

    # 문자열 정리
    df["__성명"] = df[NAME_COL].astype(str).fillna("")
    df["__출장구분"] = df[TYPE_COL].astype(str).fillna("")
    df["__출장지"] = df.get(PLACE_COL, "").astype(str)
    df["__출장목적"] = df.get(PURPOSE_COL, "").astype(str)
    df["__사업정보"] = df.get(BIZINFO_COL, "").astype(str)

    # ① 단가 허용 여부
    df["허용단위금액여부"] = df["__지급액"].isin(ALLOWED_AMOUNTS)
    df["만원단위여부"] = (df["__지급액"] % 10000 == 0)
    df["이상여부"] = ~df["허용단위금액여부"]

    # ② 같은 날 같은 사람 중복 지급 의심
    dup_counts = df.groupby(["__성명", "근무일"])["__지급액"].transform("size")
    df["중복의심여부"] = dup_counts > 1

    # ③ 시간 요건 참고 플래그
    # 단순 규칙: 관내-종일인데 4시간 미만, 관내-반일인데 2시간 미만, 또는 0 이하
    t = df["소요시간_시간"].fillna(0)
    kind = df["__출장구분"]
    cond_full_short = kind.str.contains("종일", na=False) & (t < 4)
    cond_half_short = kind.str.contains("반일", na=False) & (t < 2)
    cond_invalid = t <= 0
    df["시간요건의심여부"] = cond_full_short | cond_half_short | cond_invalid

    # ④ 관외인데 관내로 들어간 의심 (단순 키워드)
    place = df["__출장지"]
    if HOME_REGION_KEYWORDS:
        home_pattern = "|".join(HOME_REGION_KEYWORDS)
        is_home = place.str.contains(home_pattern, na=False)
    else:
        is_home = False
    if OUTER_REGION_HINTS:
        outer_pattern = "|".join(OUTER_REGION_HINTS)
        outer_hint = place.str.contains(outer_pattern, na=False)
    else:
        outer_hint = False
    df["관외관내불일치의심여부"] = df["__출장구분"].str.contains("관내", na=False) & outer_hint & ~is_home

    # ⑤ 사업정보·예산 코드 의심 (관내여비 문구 여부)
    df["예산코드의심여부"] = ~df["__사업정보"].str.contains("관내여비", na=False)

    # 월별 요약
    grouped = df.groupby("연월")
    summary = grouped.agg(
        관내여비_총액=("__지급액", "sum"),
        지급건수=("__지급액", "size"),
        허용단위금액_건수=("허용단위금액여부", "sum"),
        이상행_건수=("이상여부", "sum"),
        최소금액=("__지급액", "min"),
        최대금액=("__지급액", "max"),
        파일수=("__파일명", "nunique"),
        중복의심_건수=("중복의심여부", "sum"),
        시간요건의심_건수=("시간요건의심여부", "sum"),
        관외관내불일치의심_건수=("관외관내불일치의심여부", "sum"),
        예산코드의심_건수=("예산코드의심여부", "sum"),
    ).reset_index()
    summary["전건_허용단위금액"] = summary["지급건수"] == summary["허용단위금액_건수"]

    # 상세(단가 이상행 + 추가 플래그 전체)
    detail = df.copy()
    keep_cols = [
        "연월", "근무일", "__시작", "__종료",
        "__성명", "__지급액", "__여비금액",
        "__출장구분", "__출장지", "__출장목적",
        "소요시간_시간",
        "허용단위금액여부", "만원단위여부", "이상여부",
        "중복의심여부", "시간요건의심여부",
        "관외관내불일치의심여부", "예산코드의심여부",
        "__파일명", "__시트명",
    ]
    detail = detail[keep_cols].rename(columns={
        "__시작": "시작일시",
        "__종료": "종료일시",
        "__성명": "성명",
        "__지급액": "지급액",
        "__여비금액": "여비금액",
        "__출장구분": "출장구분",
        "__출장지": "출장지",
        "__출장목적": "출장목적",
    })

    explanation_text = make_explanation(summary)
    summary_csv = summary.to_csv(index=False)
    detail_csv = detail.to_csv(index=False)
    return summary_csv, detail_csv, explanation_text
      `;

      pyodide.runPython(pythonCode);
      logEl.textContent = "Pyodide + pandas 로딩 완료. CSV 파일 선택하고 '검증 실행' 누르면 됨.";
      return pyodide;
    }

    pyodideReadyPromise = initPyodideAndPackages();

    async function runAudit() {
      const logEl = document.getElementById("pyLog");
      const summaryOutput = document.getElementById("summaryOutput");
      const detailOutput = document.getElementById("detailOutput");
      const explainOutput = document.getElementById("explainOutput");

      summaryOutput.value = "";
      detailOutput.value = "";
      explainOutput.value = "";

      const fileInput = document.getElementById("fileInput");
      const files = fileInput.files;
      if (!files || files.length === 0) {
        alert("관내·관외 여비 CSV 파일을 하나 이상 선택해야 함.");
        return;
      }

      logEl.textContent = "Pyodide 준비 상태 확인 중...";
      const pyodide = await pyodideReadyPromise;

      try { pyodide.FS.mkdir("uploads"); } catch (e) {}

      logEl.textContent = `CSV 파일 ${files.length}개를 브라우저로 읽는 중...`;

      const filePaths = [];
      for (const file of files) {
        const arrayBuffer = await file.arrayBuffer();
        const uint8Array = new Uint8Array(arrayBuffer);
        const safeName = "uploads/" + file.name.replace(/[^a-zA-Z0-9._-]/g, "_");
        pyodide.FS.writeFile(safeName, uint8Array);
        filePaths.push(safeName);
      }

      logEl.textContent = `CSV ${files.length}개를 FS에 저장 완료. 파이썬으로 관내여비 확장 검증 돌리는 중...`;

      try {
        const fileListLiteral = JSON.stringify(filePaths);
        const code = `
import traceback
file_list = ${fileListLiteral}
try:
    summary_csv, detail_csv, explanation_text = audit_inner_travel_csv(file_list)
except Exception as e:
    tb = traceback.format_exc()
    raise RuntimeError("PYTHON_TRACEBACK\\n" + tb)
`;
        await pyodide.runPythonAsync(code);

        const summary_csv = pyodide.globals.get("summary_csv");
        const detail_csv = pyodide.globals.get("detail_csv");
        const explanation_text = pyodide.globals.get("explanation_text");

        summaryOutput.value = summary_csv.toString();
        detailOutput.value = detail_csv.toString();
        explainOutput.value = explanation_text.toString();

        logEl.textContent =
          "검증 끝. 아래 월별 요약이랑 상세 플래그, 설명 뜬 거 보고 필요하면 엑셀·보고서에 갖다 붙이면 됨.";
      } catch (err) {
        console.error(err);
        const msg = String(err);
        logEl.textContent =
          "검증 중 오류 남.\n\n" +
          "아래 파이썬 오류코드(PYTHON_TRACEBACK 포함) 같이 보내주면 원인 찾기 쉬움.\n\n" +
          "=== 오류 상세 ===\n" +
          msg;
      }
    }

    document.getElementById("runAuditBtn").addEventListener("click", runAudit);
  </script>
      <a class="btn" href="/" style="margin-top:10px;">메인으로 돌아가기</a>
  
<footer style="text-align:center; margin-top:15px; color:#444;">
  제작자: 씩씩하고 귀여운 고주무관 · Contact: edusproutcomics@naver.com · 개인적인 토이 프로젝트입니다.
</footer>

  <script src="/static/global-loader.js?v=1"></script>
  
</body>
</html>
